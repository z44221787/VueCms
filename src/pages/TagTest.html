<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script type="text/javascript" src="/node_modules/avalon2/dist/avalon.js"></script>
    <script type="text/javascript" src="/node_modules/jquery/dist/jquery.js"></script>
    <script type="text/javascript" src="/node_modules/art-template/lib/template-web.js"></script>
    <script type="text/javascript" src="/src/lib//mmRequest/dist/mmRequest.js"></script>
    <script type="text/javascript" src="/src/lib/mmRouter/dist/mmRouter.js"></script>
    <script type="text/javascript" src="/src/lib/mmDeferred/mmPromise.js"></script>
    <style>
        /* 解决页面初始化加载出现花括号 */
        .ms-controller {
            display: none;
        }
    </style>
</head>

<script>
    /*调整{{ }}模式为{% %}，兼容art-template*/
    avalon.config({
        interpolate: ['{%', '%}']
    });

    avalon.getJSON("./pig.json", function (data) {
        console.info(data);
    });

    var vm = avalon.define({
        $id: 'test',
        currPath: '',
        child: {
            child: "默认内容"
        },
        data: [{
            classname: "dd"
        }, {
            classname: "cc"
        }],
    });

    //单页应用路由
    avalon.router.add("/aaa", function (a) {
        vm.currPath = this.path
        // this里面能拿到如下东西:
        // path: 路径
        // query: 一个对象，就是？后面的东西转换成的对象
        // params: 一个对象， 我们在定义路由规则时，那些以冒号开始的参数组成的对象
    })
    avalon.router.add("/bbb", function (a) {
        vm.currPath = this.path
    })
    avalon.router.add("/ccc", function (a) {
        vm.currPath = this.path

    })
    avalon.router.add("/ddd/:ddd/:eee", function (a) { //:ddd为参数
        vm.currPath = this.path
        console.log(this.query)
        console.log(this.params)
    })
    //启动路由监听
    avalon.history.start({
        root: "/mmRouter"
    })
    // avalon.scan(document.body);
    avalon.component('ms-class', {
        template: (function () {
            var html = [];
            html.push(
                "<div><slot name='classlist'></slot>"
            );
            html.push("</div>");
            return html.join("");
        }).call(this),
        defaults: {
            data: [{
                classname: "dd"
            }, {
                classname: "cc"
            }],
            onInit: function (e, ee) {
                //集合arttemplate二次开发集成组件
                var that = this;
                var source = e.target;
                var sources = jQuery(e.target).find("[slot]");
                jQuery(source).each(function (i, elem) {
                    var htmlStr = jQuery(elem).get(0).innerHTML;
                    var render = template.compile(htmlStr);
                    var data = {};
                    data.data = that.$model.data;
                    var html = render(data);
                    $(html).replaceAll(jQuery(elem));
                });
            },
            onReady: function (e, ee) {
                console.info("onReady");
            },
            onViewChange: function (e) {
                //集合arttemplate二次开发集成组件
                var that = this;
                var source = e.target;
                var sources = jQuery(e.target).find("[slot]");
                jQuery(source).each(function (i, elem) {
                    var htmlStr = jQuery(elem).get(0).innerHTML;
                    var render = template.compile(htmlStr);
                    var data = {};
                    data.data = that.$model.data;
                    var html = render(data);
                    $(html).replaceAll(jQuery(elem));
                });
            },
            onDispose: function () {
                console.info("onDispose");
            },
        },
        soleSlot: 'data',
        getTemplate: function (vm, template) {
            console.info(vm);
            console.info(template);
        }
    });

    //组件嵌套(栏目信息和文章信息)
    var classInfo, docInfo;

    //获取栏目组件
    avalon.component("ms-channel", {
        template: (function () {
            var htmlArray = new Array();
            htmlArray.push("<div id='parent'><slot name='channel'></slot></div>");
            return htmlArray.join("");
        }).call(this),
        defaults: {
            ids: "",
            onInit: function (e) {
                //根据栏目编号获取栏目信息
                // avalon.serialize(element)//序列化

                //集合arttemplate二次开发集成组件
                var that = this;
                var source = e.target;
                var sources = jQuery(e.target).find("slot[name='channel']");
                jQuery(source).each(function (i, elem) {
                    var htmlStr = jQuery(elem).get(0).innerHTML;
                    var render = template.compile(htmlStr);
                    var data = {};
                    data.data = that.$model.data;
                    var html = render(data);
                    $(html).replaceAll(jQuery(elem));
                });
                parent = e.vmodel;
            },
            onReady: avalon.noop,
            onViewChange: avalon.noop,
            onDispose: avalon.noop
        },
        soleSlot: "channel"
    });

    avalon.component("ms-document", {
        template: (function () {
            var htmlArray = new Array();
            htmlArray.push("<slot name='doc'></slot>");
            return htmlArray.join("");
        }).call(this),
        defaults: {
            onInit: function (e) {
                child = e.vmodel;
                console.info("子级节点输出" + parent);
            },
            onReady: avalon.noop,
            onViewChange: avalon.noop,
            onDispose: avalon.noop
        },
        soleSlot: "doc"
    });
</script>

<body>
    <div ms-controller="test">
        <h1>avalon2+mmRouter路由控制</h1>
        <p><a href='#!/aaa'>点我</a></p>
        <p><a href='#!/bbb'>点我</a></p>
        <p><a href='#!/ccc'>点我</a></p>
        <p><a href='#!/ddd/111/222'>点我</a></p>
        <p>{%currPath%}</p>
        <br />
        <!-- <li :for="(i,v) in data">{% @v.classname %}</li>
            <xmp ms-widget='[{is:"ms-class"},@data]'>
                {{each data value i}}
                <li>索引 {{i + 1}} ：{{value}}</li>
                {{/each}}
            </xmp> -->
    </div>

    <h1>avalon2+组件组合art-template，新闻cms系统组件（获取栏目组件,获取新闻内容组件,组件嵌套）</h1>
    <ms-parent></ms-parent>
    <xmp :widget='{is:"ms-channel", $id:"parent",ids:"通知公告"}'>
        <ul>
            <ms-document :widget='{top:7}'>
            </ms-document>
        </ul>
    </xmp>

    <xmp :widget='{is:"ms-channel", $id:"parent",ids:"图片新闻"}'>
        <ul>
            <ms-document :widget='{top:7}'>
            </ms-document>
        </ul>
    </xmp>
</body>




<!-- <xmp slot="doclist" ms-widget='{is:"ms-newlist"}'></xmp> -->
<!-- <xmp ms-widget="{is:'ms-newlist'}"></xmp> -->
<!-- 
<body ms-controller="test">
    <ms-button ms-widget="@button"></ms-button>
    <xmp ms-widget='[{is:"ms-button"},@button]'></xmp>
    <wbr ms-widget='[{is:"ms-button"},@button]'/>
    <template ms-widget='[{is:"ms-button"},@button]'></template>
</body> -->

</html>